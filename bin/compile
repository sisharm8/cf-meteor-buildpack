BUILD_DIR=$1
CACHE_DIR=$2

indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";; # mac/bsd sed: -l buffers on line boundaries
    *)      sed -u "$c";; # unix/gnu sed: -u unbuffered (arbitrary) chunks of data
  esac
}

status() {
  echo "-----> $*"
}

node_version=$(curl --silent --get https://semver.io/node/resolve/0.10.x)

install_node() {
  if [ -f "$BUILD_DIR/.vendor/node/bin/node" ] ; then
    status "Skipping Node installation. Already installed."
    return
  fi

  # Download node from Heroku's S3 mirror of nodejs.org/dist
  status "Downloading and installing node $node_version"
  NODE_INSTALLER=node-installer.tar.gz
  NODE_URL="http://s3pository.heroku.com/node/v$node_version/node-v$node_version-linux-x64.tar.gz"
  curl $NODE_URL > $NODE_INSTALLER
  tar xzf $NODE_INSTALLER -C $BUILD_DIR

  # Move node (and npm) into ./.vendor and make them executable
  mkdir -p $BUILD_DIR/.vendor
  mv $BUILD_DIR/node-v$node_version-linux-x64 $BUILD_DIR/.vendor/node
  chmod +x $BUILD_DIR/.vendor/node/bin/*
  PATH=$BUILD_DIR/.vendor/node/bin:$PATH
}

build() {
  (
    echo "Starting build phase for custom buildpack..."
    cd $BUILD_DIR/programs/server
    ls -lrt
    echo "Installing npm dependencies"
    npm install
  )
}

install_node
build
